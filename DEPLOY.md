# Инструкция по деплою проекта

## Описание

Команда `php artisan deploy` автоматизирует процесс деплоя проекта:
1. Собирает React приложение из `frontend/`
2. Коммитит изменения в git
3. Отправляет изменения в удаленный репозиторий
4. Отправляет POST запрос на сервер для автоматического обновления

## Настройка

### 1. Переменные окружения

Добавьте в `.env` следующие переменные:

```env
# URL сервера для отправки запроса на деплой
DEPLOY_SERVER_URL=https://your-server.com

# Токен для авторизации запроса деплоя
DEPLOY_TOKEN=your-secret-token

# URL git репозитория (опционально, если не указан - берется из git remote)
GIT_REPOSITORY_URL=https://github.com/username/repo.git
```

### 2. Настройка .gitignore

**ВАЖНО:** Собранные файлы из `frontend/dist` НЕ должны быть в `.gitignore`, так как они нужны для деплоя на сервер.

В `.gitignore` должны быть:
- `/frontend/node_modules` - зависимости React
- НЕ должно быть `/frontend/dist` - собранные файлы

## Использование

### Базовое использование

```bash
php artisan deploy
```

### Опции команды

```bash
# Кастомное сообщение для коммита
php artisan deploy --message="Исправлена критическая ошибка"

# Пропустить сборку фронтенда
php artisan deploy --skip-build

# Показать что будет сделано без выполнения (dry-run)
php artisan deploy --dry-run

# Отключить проверку SSL сертификата (для разработки)
php artisan deploy --insecure

# Выполнить seeders на сервере
php artisan deploy --with-seed

# Принудительная отправка (force push)
php artisan deploy --force

# Указать путь к npm вручную (для shared-хостинга)
php artisan deploy --npm-path=/home/user/.nvm/versions/node/v20.10.0/bin/npm

# Указать путь к composer вручную (для shared-хостинга)
php artisan deploy --composer-path=/home/user/bin/composer

# Комбинация опций
php artisan deploy --message="Новая версия" --insecure
```

## Процесс деплоя

Команда выполняет следующие шаги:

1. **Сборка фронтенда** (`frontend/`)
   - Выполняет `npm run build` в папке `frontend/`
   - Проверяет наличие `frontend/dist/index.html`

2. **Проверка git статуса**
   - Проверяет наличие изменений
   - Предупреждает о больших файлах (>10MB)

3. **Проверка git remote**
   - Убеждается, что remote origin настроен правильно
   - При необходимости добавляет или обновляет remote

4. **Добавление изменений в git**
   - Принудительно добавляет `frontend/dist` (даже если в .gitignore)
   - Добавляет все остальные изменения

5. **Создание коммита**
   - Создает коммит с указанным или автоматическим сообщением

6. **Отправка в репозиторий**
   - Отправляет изменения в удаленный репозиторий
   - Поддерживает force push при необходимости

7. **Отправка запроса на сервер**
   - Отправляет POST запрос на `DEPLOY_SERVER_URL/api/deploy`
   - Передает commit hash, branch, timestamp и другие данные
   - Сервер автоматически обновляет код из git

## Требования

- Git должен быть установлен и настроен
- Node.js и npm должны быть установлены (для сборки фронтенда)
- React приложение должно быть в папке `frontend/` (опционально)
- На сервере должен быть настроен endpoint `/api/deploy` для приема запросов
  - Контроллер: `app/Http/Controllers/Api/DeployController.php`
  - Роут: `routes/api.php` → `POST /api/deploy`
  - **Инструкция:** `SERVER_DEPLOY_ENDPOINT.md`

## Настройка для Shared-хостинга (Beget)

Команда автоматически определяет пути к `npm` и `composer`. Для shared-хостинга (например, Beget) рекомендуется:

1. **Настроить сервер** согласно инструкции в `SETUP_SERVER.md`
2. **Или указать пути в `.env`**:

```env
# Пути к инструментам (опционально, определяется автоматически)
NPM_PATH=/home/login/.nvm/versions/node/v20.10.0/bin/npm
COMPOSER_PATH=/home/login/bin/composer
```

3. **Или использовать опции команды**:

```bash
php artisan deploy --npm-path=/home/login/.nvm/versions/node/v20.10.0/bin/npm
```

### Автоматическое определение путей

Команда определяет пути в следующем порядке:

**Для npm:**
1. Опция `--npm-path`
2. Переменная `NPM_PATH` в `.env`
3. Команда `which npm` (если в PATH)
4. Поиск в `~/.nvm/versions/node/*/bin/npm`
5. Стандартный путь `npm`

**Для composer:**
1. Опция `--composer-path`
2. Переменная `COMPOSER_PATH` в `.env`
3. Команда `which composer` (если в PATH)
4. Поиск в `~/bin/composer`
5. Стандартный путь `composer`

## Устранение проблем

### Ошибка сборки фронтенда

Если сборка не выполняется:
- Убедитесь, что в `frontend/` есть `package.json`
- Проверьте, что все зависимости установлены: `cd frontend && npm install`
- Проверьте конфигурацию Vite
- **Для shared-хостинга**: убедитесь, что npm доступен. Проверьте путь:
  ```bash
  which npm
  # или
  ~/.nvm/versions/node/vXX.X.X/bin/npm --version
  ```
- Укажите путь к npm в `.env` или через опцию `--npm-path`

### Ошибка отправки в git

Если не удается отправить в репозиторий:
- Проверьте настройки git remote: `git remote -v`
- Убедитесь, что у вас есть права на запись в репозиторий
- При необходимости используйте `--force` (осторожно!)

### Ошибка подключения к серверу

Если не удается подключиться к серверу:
- Проверьте `DEPLOY_SERVER_URL` в `.env`
- Проверьте доступность сервера
- При проблемах с SSL используйте `--insecure` (только для разработки)
- Проверьте настройки файрвола

## Безопасность

- **НЕ используйте `--insecure` в продакшене** - это отключает проверку SSL
- **НЕ используйте `--force` без необходимости** - это может перезаписать удаленные коммиты
- Храните `DEPLOY_TOKEN` в секрете, не коммитьте его в git
- Используйте HTTPS для `DEPLOY_SERVER_URL` в продакшене

